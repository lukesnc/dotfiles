#!/usr/bin/env bash

set -eo pipefail

show_help() {
    cat <<EOF
usage: ${0##*/} [-32ah] FILE
Quickly rip the vst3/vst/component folder out of a plugin installer package. Makes use of pkgutil, tar, 7z
  -3  Search for VST3 assets [.vst3] (default mode)
  -2  Search for VST2 assets [.vst]
  -a  Search for AU assets [.component]
  -h  Print this message and exit
EOF
}

# Set mode of operation (VST3, VST, AU)
# Default mode is VST3
mode='3'
installpath='/Library/Audio/Plug-Ins/VST3'
searchpattern='*.vst3'

OPTIND=1
while getopts '32ah' opt; do
    case "$opt" in
    2)
        mode='2'
        installpath='/Library/Audio/Plug-Ins/VST'
        searchpattern='*.vst'
        ;;
    a)
        mode='a'
        installpath='/Library/Audio/Plug-Ins/Components'
        searchpattern='*.component'
        ;;
    h)
        show_help
        exit 0
        ;;
    esac
done
shift "$((OPTIND - 1))"

# Get file path (required)
if [[ -z $1 ]]; then
    show_help
    exit 1
elif [[ ! -e $1 ]]; then
    echo "error: $1 is not a valid path"
    exit 1
fi

inpath=$(realpath "$1")
echo "Processing $inpath"

# Save original inpath to env variable, in case the script
# calls itself
if [[ -z $VSTEXTRACT_ORIG_INPATH ]]; then
    export VSTEXTRACT_ORIG_INPATH="$inpath"
fi

# Extract
extractpath=$(mktemp -u)
case "$inpath" in
*.tar* | *.zip | *.7z)
    command -v tar
    mkdir -p "$extractpath"
    tar -xzf "$inpath" -C "$extractpath"
    ;;
*.pkg)
    command -v pkgutil
    pkgutil --expand-full "$inpath" "$extractpath"
    ;;
*.dmg)
    command -v 7z
    7z x "$inpath" -o"$extractpath" >/dev/null
    ;;
*)
    echo "error: unsupported archive format $1"
    exit 1
    ;;
esac

# Find artifact and copy to VST3 path
artifact=$(find "$extractpath" -name "$searchpattern" -print -quit)
if [[ -z $artifact ]]; then
    echo "error: Could not find plugin assets in $extractpath"

    # Check if we should run the search again
    for ext in '*.pkg' '*.dmg' '*.tar*' '*.zip'; do
        again=$(find "$extractpath" -name "$ext" -type f -print -quit)
        if [[ -n $again ]]; then
            echo 'Found installer within parent package, retrying'
            exec "$0" "-$mode" "$again"
        fi
    done

    exit 1
fi
echo "Found $(basename "$artifact")"

echo "Attempting to move plugin to $installpath"
sudo mkdir -p "$installpath"
sudo cp -r "$artifact" "$installpath"
echo "Plugin successfully copied to $installpath/$(basename "$artifact")"

read -p "Delete original $VSTEXTRACT_ORIG_INPATH [y/N]: " yn
if [[ $yn == [Yy]* ]]; then
    rm -v "$VSTEXTRACT_ORIG_INPATH"
fi
